name: Data Validation Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-data:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create reports directories
      run: |
        mkdir -p reports/profiling
        mkdir -p great_expectations/uncommitted/data_docs/local_site

    - name: Pull DVC baseline
      run: |
        pip install dvc
        dvc pull

    - name: Run data validation
      id: validation
      run: |
        echo "Running validation on clean dataset..."
        python scripts/validate_data.py data/raw/churn_clean.csv > validation_output.txt 2>&1
        exit_code=$?
        echo "validation_exit_code=$exit_code" >> $GITHUB_OUTPUT
        
        echo "validation_output<<EOF" >> $GITHUB_ENV
        cat validation_output.txt >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
      continue-on-error: true

    - name: Detect drift against baseline
      id: drift
      run: |
        echo "Running drift detection..."
        python scripts/detect_drift.py data/raw/churn_clean.csv > drift_output.txt 2>&1
        drift_exit_code=$?
        echo "drift_exit_code=$drift_exit_code" >> $GITHUB_OUTPUT
        
        echo "drift_output<<EOF" >> $GITHUB_ENV
        cat drift_output.txt >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
      continue-on-error: true

    - name: Generate profiling report
      run: python scripts/profile_dataset.py data/raw/churn_clean.csv

    - name: Generate Data Docs
      run: python -c "import great_expectations as gx; context = gx.get_context(); context.build_data_docs()"

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: validation-artifacts
        path: |
          great_expectations/uncommitted/data_docs/local_site/
          reports/profiling/
        retention-days: 30

    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const validationExitCode = ${{ steps.validation.outputs.validation_exit_code }};
          const driftExitCode = ${{ steps.drift.outputs.drift_exit_code }};
          const runId = context.runId;
          const repo = context.repo;
          
          let status = (validationExitCode == '0' && driftExitCode == '0') ? '‚úÖ **PASS**' : '‚ùå **FAIL**';
          
          const commentBody = `## üìä Data Quality Report
          
          **Status:** ${status}
          **Workflow:** [View Details](https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId})
          
          ### Validation: ${validationExitCode == '0' ? '‚úÖ PASS' : '‚ùå FAIL'}
          \`\`\`
          ${`${{ env.validation_output }}`.split('\n').slice(-8).join('\n')}
          \`\`\`
          
          ### Drift Detection: ${driftExitCode == '0' ? '‚úÖ PASS' : '‚ùå FAIL'}
          \`\`\`
          ${`${{ env.drift_output }}`.split('\n').slice(-6).join('\n')}
          \`\`\`
          
          ${(validationExitCode != '0' || driftExitCode != '0') ? '‚ùå **Merge blocked** - Fix issues before merging.' : '‚úÖ **Ready to merge!**'}
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: repo.owner,
            repo: repo.repo,
            body: commentBody
          });

    - name: Fail if validation or drift failed
      if: steps.validation.outputs.validation_exit_code != '0' || steps.drift.outputs.drift_exit_code != '0'
      run: exit 1