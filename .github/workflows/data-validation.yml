name: Data Validation Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-data:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write  # Required for posting comments
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create reports directories
      run: |
        mkdir -p reports/profiling
        mkdir -p great_expectations/uncommitted/data_docs/local_site

    - name: Run data validation
      id: validation
      run: |
        echo "Running validation on clean dataset..."
        python scripts/validate_data.py data/raw/churn_clean.csv > validation_output.txt 2>&1
        exit_code=$?
        echo "validation_exit_code=$exit_code" >> $GITHUB_OUTPUT
        
        # Save output for comment
        echo "validation_output<<EOF" >> $GITHUB_ENV
        cat validation_output.txt >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        
        # Always return success here to allow next steps, but we'll fail at the end
        exit 0

    - name: Generate profiling report
      run: |
        echo "Generating profiling report..."
        python scripts/profile_dataset.py data/raw/churn_clean.csv

    - name: Generate Data Docs
      run: |
        python -c "import great_expectations as gx; context = gx.get_context(); context.build_data_docs()"

    - name: Upload Great Expectations Data Docs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: data-docs
        path: great_expectations/uncommitted/data_docs/local_site/
        retention-days: 30

    - name: Upload Profiling Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: profiling-reports
        path: reports/profiling/
        retention-days: 30

    - name: Comment PR with validation results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const exitCode = ${{ steps.validation.outputs.validation_exit_code }};
          const output = `${{ env.validation_output }}`;
          const runId = context.runId;
          const repo = context.repo;
          
          let status = exitCode == '0' ? '‚úÖ **PASS**' : '‚ùå **FAIL**';
          let color = exitCode == '0' ? 'success' : 'failure';
          
          const commentBody = `## üìä Data Validation Report
          
          **Status:** ${status}
          
          **Workflow Run:** [View Details](https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId})
          
          ### Validation Summary
          \`\`\`
          ${output.split('\n').slice(-10).join('\n')}
          \`\`\`
          
          ### Artifacts
          - üìÑ [Great Expectations Data Docs](https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId})
          - üìà [Profiling Reports](https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId})
          
          ${exitCode == '0' ? '‚úÖ Ready to merge!' : '‚ùå Please fix validation errors before merging.'}`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: repo.owner,
            repo: repo.repo,
            body: commentBody
          });

    - name: Fail workflow if validation failed
      if: steps.validation.outputs.validation_exit_code != '0'
      run: |
        echo "‚ùå Data validation failed. Merge blocked."
        exit 1